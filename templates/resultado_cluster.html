{% extends "base.html" %}
{% block title %}Resultados del clÃºster{% endblock %}

{% block content %}
<div class="card">
  <h2>ğŸ“ Municipios con {{ cluster }}</h2>

  <!-- MAPA -->
  <div id="grafico-cluster" style="height:600px;"></div>

  <!-- INFO MUNICIPIO -->
<div id="info-municipio" class="info-card" style="display:none;">
  <h3 id="info-nombre" class="info-title"></h3>

  <!-- MÃ‰TRICAS -->
  <div class="info-metrics">
    <div class="metric">
      <span class="metric-label">Ãndice de atractividad</span>
      <span class="metric-value" id="info-indice"></span>
    </div>
    <div class="metric">
      <span class="metric-label">Ranking en el clÃºster</span>
      <span class="metric-value" id="info-ranking"></span>
    </div>
  </div>

  <!-- ACCIONES -->
  <div class="info-actions">
    <button id="btn-graficos" class="btn-secundario">
      ğŸ“Š Mostrar grÃ¡ficos
    </button>
  </div>
</div>


  <!-- GRÃFICOS -->
  <div id="graficos-municipio" style="display:none; margin-top:24px;">
    <div id="grafico-radar" style="height:300px;"></div>
    <div id="grafico-barra" style="height:300px;"></div>
    <div id="grafico-distribucion" style="height:250px;"></div>
  </div>

  <!-- RANKING -->
  <button id="btn-ranking" class="btn-secundario" style="margin-top:20px;">
    ğŸ† Mostrar ranking completo del clÃºster
  </button>

  <div id="ranking-cluster" class="ranking-card" style="display:none;">
    <h3>ğŸ† Ranking del clÃºster</h3>
    <ul id="lista-ranking" class="ranking-list"></ul>
  </div>

  <a href="{{ url_for('estudio_cluster') }}" class="btn-secundario" style="margin-top:20px;">
    ğŸ”™ Volver
  </a>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<script>
const fig = JSON.parse({{ grafico | tojson | safe }});
const datos = {{ datos | tojson | safe }};
const plotDiv = document.getElementById("grafico-cluster");

const baseWidth = fig.data[0].marker.line.width || 1;
const baseColor = fig.data[0].marker.line.color || "black";

fig.data[0].selected = {
  marker: { line: { color:"#1976d2", width: baseWidth + 2 } }
};
fig.data[0].unselected = {
  marker: { line: { color: baseColor, width: baseWidth } }
};

Plotly.newPlot(plotDiv, fig.data, fig.layout);

let selectedIndex = null;
let municipioSeleccionado = null;

// HOVER
plotDiv.on("plotly_hover", e => {
  Plotly.restyle(plotDiv, { selectedpoints:[[e.points[0].pointIndex]] });
});

plotDiv.on("plotly_unhover", () => {
  if (selectedIndex === null) {
    Plotly.restyle(plotDiv, { selectedpoints:[null] });
  }
});

// CLICK
plotDiv.on("plotly_click", e => {
  selectedIndex = e.points[0].pointIndex;
  Plotly.restyle(plotDiv, { selectedpoints:[[selectedIndex]] });

  const nombre = e.points[0].hovertext;
  municipioSeleccionado = datos.find(d => d.Nombre === nombre);

  if (municipioSeleccionado) {
    document.getElementById("info-nombre").innerText = municipioSeleccionado.Nombre;
    document.getElementById("info-indice").innerText =
      municipioSeleccionado.total.toFixed(3);
    document.getElementById("info-ranking").innerText =
      "#" + municipioSeleccionado.ranking;
    document.getElementById("info-municipio").style.display = "block";
  }
});

// BOTÃ“N GRÃFICOS
const btnGraficos = document.getElementById("btn-graficos");
const graficosDiv = document.getElementById("graficos-municipio");

btnGraficos.addEventListener("click", () => {
  if (graficosDiv.style.display === "none") {
    graficosDiv.style.display = "block";
    btnGraficos.innerText = "âŒ Ocultar grÃ¡ficos";
    renderGraficos();
  } else {
    graficosDiv.style.display = "none";
    btnGraficos.innerText = "ğŸ“Š Mostrar grÃ¡ficos";
  }
});

function renderGraficos() {
  const m = municipioSeleccionado;
  if (!m) return;

  // RADAR
  Plotly.newPlot("grafico-radar", [{
    type:"scatterpolar",
    r:[m.educacion,m.salud,m.transporte,m.economia,m.housing],
    theta:["EducaciÃ³n","Salud","Transporte","EconomÃ­a","Vivienda"],
    fill:"toself"
  }], {
    title:"Perfil del municipio",
    polar:{radialaxis:{range:[0,1]}},
    margin:{t:40}
  });

  // BARRA
  Plotly.newPlot("grafico-barra", [{
    type:"bar",
    x:["Municipio","Media clÃºster"],
    y:[m.total, datos.reduce((a,b)=>a+b.total,0)/datos.length]
  }], { title:"Ãndice vs media del clÃºster" });

  // DISTRIBUCIÃ“N
  Plotly.newPlot("grafico-distribucion", [{
    type:"box",
    y:datos.map(d=>d.total),
    boxpoints:false
  }], { title:"DistribuciÃ³n del Ã­ndice en el clÃºster" });
}

// RANKING COMPLETO
const btnRanking = document.getElementById("btn-ranking");
const rankingDiv = document.getElementById("ranking-cluster");
const listaRanking = document.getElementById("lista-ranking");

btnRanking.addEventListener("click", () => {
  if (rankingDiv.style.display === "none") {
    listaRanking.innerHTML = "";
    datos.sort((a,b)=>a.ranking-b.ranking).forEach(d=>{
      const li=document.createElement("li");
      li.innerHTML=`<span class="rank">#${d.ranking}</span><span>${d.Nombre}</span><span>${d.total.toFixed(3)}</span>`;
      listaRanking.appendChild(li);
    });
    rankingDiv.style.display="block";
    btnRanking.innerText="âŒ Ocultar ranking";
  } else {
    rankingDiv.style.display="none";
    btnRanking.innerText="ğŸ† Mostrar ranking completo del clÃºster";
  }
});
</script>

<style>
 .ranking-card {
  margin-top:24px; padding:20px; border-radius:14px;
  background:#fff; box-shadow:0 8px 20px rgba(0,0,0,.08);
}
  .info-card {
  margin-top: 24px;
  padding: 24px;
  border-radius: 16px;
  background: #ffffff;
  box-shadow: 0 8px 24px rgba(0,0,0,0.08);
  text-align: center;
}

.info-title {
  margin-bottom: 20px;
  font-size: 1.4rem;
}

.info-metrics {
  display: flex;
  gap: 24px;
  justify-content: center;
  margin-bottom: 20px;
}

.metric {
  min-width: 180px;
  background: #f6f7fb;
  padding: 16px;
  border-radius: 14px;
}

.metric-label {
  display: block;
  font-size: 0.85rem;
  color: #666;
  margin-bottom: 6px;
}

.metric-value {
  font-size: 1.4rem;
  font-weight: 700;
}

.info-actions {
  display: flex;
  justify-content: center;
}

.ranking-list { list-style:none; padding:0; }
.ranking-list li {
  display:grid; grid-template-columns:60px 1fr 80px;
  padding:10px; margin-bottom:6px; background:#f3f4f7; border-radius:10px;
}
.rank { font-weight:bold; color:#1976d2; }
</style>

{% endblock %}
